<!DOCTYPE html>
<html ng-app="sortableApp" ng-controller="myController">
<head>
<meta charset="UTF-8">
<title ng-model="projectName">{{projectName}}</title>

<script
	src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script type="text/javascript"
	src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.13/angular.min.js"></script>
<script
	src="//rawgithub.com/angular-ui/ui-sortable/master/src/sortable.js"></script>

<link rel="stylesheet"
	href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<link rel="stylesheet"
	href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
<script
	src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

<script type="text/javascript"
	src="//cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.10.0/ui-bootstrap-tpls.min.js"></script>
<script
	src="//m-e-conroy.github.io/angular-dialog-service/javascripts/dialogs.min.js"
	type="text/javascript"></script>
<script
	src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.13/angular-sanitize.js"></script>
<script type="text/javascript" src="scripts/showdown.js"></script>
<script type="text/javascript" src="scripts/markdown.js"></script>
<link rel="stylesheet" href="scripts/todo.css">

</head>
<body>
	<div id="header" ng-include="'template/header.html'"
		style="margin: 0; padding: 0"></div>
	<div style="margin: 20px" ng-controller="sortableController">
		<div class="row" ng-show="error" class="ng-hide">
			<div class="col-xs-8 col-xs-offset-2">
				<div class="alert alert-danger" role="alert">
					<button type="button" class="close">
						<span ng-click="removeError()">&times;</span><span class="sr-only">Close</span>
					</button>
					<strong>Error!</strong><span style="margin-left: 10px">{{error}}</span>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-xs-1" align="left">
				<button class="btn btn-default glyphicon glyphicon-plus"
					style="height: 30px; margin-top: 10px" ng-click="createItem(0)"></button>
			</div>
			<div class="col-xs-3 toolSign" align="center" ng-click="dump()">Keep</div>
			<div class="col-xs-4 toolSign" align="center">Problem</div>
			<div class="col-xs-3 toolSign" align="center">Try</div>
			<div class="col-xs-1" align="right"></div>
		</div>
		<div class="row">
			<div ui-sortable="sortableOptions"
				class="items-container items col-xs-4" ng-model="items"
				ng-repeat="items in todos">
				<div key="{{item.key}}" class="item" ng-repeat="item in items"
					strip-br="true" ng-click="edit(item, $event)"
					btf-markdown="item.title"></div>
			</div>
		</div>
	</div>
	<script type="text/javascript">
		var myapp = angular.module('sortableApp', [ 'ui.sortable', 'ui.bootstrap', 'dialogs', 'ngSanitize', 'btford.markdown' ]);
		myapp.config([ "$locationProvider", "$httpProvider", function($locationProvider, $httpProvider) {
			$locationProvider.html5Mode(true);
			$httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';
			$httpProvider.defaults.headers.put['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';
		} ]);
		var myController = [ "$rootScope", "$scope", "$dialogs", "$modal", "$location", "$http", function($rootScope, $scope, $dialogs, $modal, $location, $http) {
			$scope.sortingLog = [];
			$scope.sortableOptions = {
				placeholder : "item",
				connectWith : ".items-container",
				update : function(e, ui) {
					setTimeout(function() {
						var movedItemKey = ui.item.attr("key");
						for ( var i in $scope.todos) {
							var items = $scope.todos[i];
							for ( var j in items) {
								var item = items[j];
								if (item.key == movedItemKey) {
									var status = i;
									var index = j;
									break;
								}
							}
							if (status) {
								break;
							}
						}
						var changeItems = [];
						for ( var i in $scope.todos[status]) {
							var item = $scope.todos[status][i];
							var changeItem = {};
							changeItem.key = item.key;
							changeItem.title = item.title;
							changeItem.status = status;
							changeItem.index = i;
							changeItems.push(changeItem);
						}
						$scope.saveSortedItems(changeItems);
					}, 0);
				},
				distance : 10
			};
			$scope.createItem = function() {
				$http({
					url : 'items',
					method : "POST",
					data : JSON.stringify({
						projectKey : $scope.projectKey,
						index : $scope.todos[0].length
					}),
					headers : {
						'Content-Type' : 'application/json'
					}
				}).success(function(item, status, headers, config) {
					item.title = "";
					item.description = "";
					$scope.todos[0].push(item);
					$scope.edit(item);
				}).error(function(data, status, headers, config) {
					$scope.error = "Load error";
				});
			}
			$scope.edit = function(item, $event) {
				$scope.editingTodo = {
					title : item.title + "",
					description : item.description + ""
				};
				var dialogController = [ "$scope", "$modalInstance", "editingTodo", function($scope, $modalInstance, editingTodo) {
					$scope.editingTodo = editingTodo;
					$scope.save = function() {
						$modalInstance.close({
							func : "update",
							item : $scope.editingTodo
						});
					};
					$scope["delete"] = function() {
						$modalInstance.close({
							func : "delete",
							item : $scope.editingTodo
						});
					};
				} ];
				var modalInstance = $modal.open({
					templateUrl : 'template/editItemDialog.html?time=' + new Date().getTime(),
					controller : dialogController,
					resolve : {
						editingTodo : function() {
							return $scope.editingTodo;
						}
					}
				});
				modalInstance.result.then(function(res) {
					if ("delete" == res.func) {
						$scope.deleteItem(item);
					} else if ("update" == res.func) {
						item.title = res.item.title;
						item.description = res.item.description;
						$scope.saveItem(item);
					}
				}, function() {
					console.log('Modal dismissed at: ' + new Date());
				});
				if ($event) {
					$event.stopPropagation();
				}
			}
			$scope.saveSortedItems = function(items) {
				$http({
					url : 'items/sort',
					method : "put",
					data : JSON.stringify(items),
					headers : {
						'Content-Type' : 'application/json'
					}
				}).success(function(item, status, headers, config) {
				}).error(function(data, status, headers, config) {
					$scope.error = "Load error";
				});
			}

			$scope.logModels = function() {
				$scope.sortingLog = [];
				for (var i = 0; i < $scope.todos.length; i++) {
					var logEntry = $scope.todos[i].map(function(x) {
						return x.title;
					}).join(', ');
					logEntry = 'container ' + (i + 1) + ': ' + logEntry;
					$scope.sortingLog.push(logEntry);
				}
			};
			$scope.projectKey = $location.search()["project_key"];
			if (!$scope.projectKey) {
				$scope.error = "project not defined";
			}
			$http.get('projects?key=' + $scope.projectKey).success(function(project, status, headers, config) {
				$rootScope.projectName = project.project.name;
				$scope.todos = [ [], [], [] ];
				for ( var i in project.items) {
					var item = project.items[i];
					$scope.todos[item.status].push(item);
				}
			}).error(function(data, status, headers, config) {
				$scope.error = "Load error";
			});
			$scope.saveItem = function(item) {
				$http({
					url : 'items',
					method : "PUT",
					data : JSON.stringify(item),
					headers : {
						'Content-Type' : 'application/json'
					}
				}).success(function(data, status, headers, config) {
				}).error(function(data, status, headers, config) {
					$scope.error = "Load error";
				});
			}

			$scope.deleteItem = function(item) {
				$http({
					url : 'items',
					method : "DELETE",
					data : JSON.stringify(item),
					headers : {
						'Content-Type' : 'application/json'
					}
				}).success(function(data, status, headers, config) {
					for ( var i in $scope.todos) {
						var items = $scope.todos[i];
						for ( var j in items) {
							var targetItem = items[j];
							if (targetItem.key == item.key) {
								$scope.todos[i].splice(j, 1);
								break;
							}
						}
						if (status) {
							break;
						}
					}
				}).error(function(data, status, headers, config) {
					$scope.error = "Load error";
				});
			}
			$scope.removeError = function() {
				$scope.error = null;
			}
			$scope.deleteDone = function() {
				$http.post('api/todo/delete', {
					projectKey : $scope.projectKey,
					todos : $scope.todos[2]
				}).error(function(data, status, headers, config) {
					$scope.error = "Delete error";
				});
				$scope.todos[2] = [];
			}
		} ];
		myapp.controller('sortableController', myController);
	</script>
</body>
</html>